<!DOCTYPE HTML>
<html onkeypress="activateMouseShortcut(event);">
	<head>
		<title></title>
		<link href="animations.css" rel="stylesheet" />
		<style>
			html
			{
				background-image: url("Images/pokerTable.jpg");
				background-size: cover;
				background-repeat: no-repeat;
				overflow-y: hidden;
			}
			#gameLogHTML
			{
				position: absolute;
				top: 20vh;
				left: 30%;
				background-color: rgba(15, 15, 15, 0.7);
				color: white;
				overflow: auto;
				font: 18pt trebuchet ms;
				padding: 8px;
				z-index: 3;
			}
			#gameLogTitleHTML
			{
				background-color: #2093e6;
				font: 32pt trebuchet ms;
				padding: 8px;
			}
			.appear
			{
				visibility: visible;
				animation-name: appear;
				animation-fill-mode: forwards;
				animation-duration: 1s;
			}
			.disappear
			{
				/*JS will asynchronously hide this*/
				animation-name: disappear;
				animation-fill-mode: forwards;
				animation-duration: 1s;
			}
			#playerStacheHTML
			{
				border-bottom: 5px solid black;
				position: absolute;
				left: 20%;
				width: 60%;
				top: 80vh;
				height: 16vh;
				overflow-x: scroll;
				overflow-y: hidden;
				white-space: nowrap;
			}
			#playBtnHTML, #bullshitBtnHTML
			{
				position: absolute;
				right: 5%;
				bottom: 5vh;
				text-align: center;
				border-radius: 50%;
				width: 150px;
				height: 150px;
				font: 28pt trebuchet ms;
				color: white;
				border: 8px outset black;
				box-shadow: 2px 2px 6px 5px black;
				cursor: pointer;
				animation-duration: 10s;
				animation-iteration-count: infinite;
				animation-direction: alternate;
			}
			#playBtnHTML
			{
				background-color: #4ac3f7;;
				animation-name: blueFlash;
			}
			#bullshitBtnHTML
			{
				background-color: #ffc936;
				animation-name: goldFlash;
			}
			.warningDivCSS
			{
				position: absolute;
				top: 70vh;
				left: 0%;
				color: #f55733;
				width: 99%;
				font: 24pt comic sans ms;
				text-align: center;
			}
			.flyssolveCSS0, .flyssolveCSS1, .flyssolveCSS2, .flyssolveCSS3, .flyssolveCSS4, .flyssolveCSS5, .flyssolveCSS6, .flyssolveCSS7, .flyssolveCSS8, .flyssolveCSS9, .flyssolveCSS10, .flyssolveCSS11, .flyssolveCSS12
			{
				position: absolute;
				animation-duration: 2s;
				animation-fill-mode: forwards;
				transform: rotateX(60deg);
			}
			.flyssolveCSS0
			{
				animation-name: flyssolve0;
			}
			.flyssolveCSS1
			{
				animation-name: flyssolve1;
			}
			.flyssolveCSS2
			{
				animation-name: flyssolve2;
			}
			.flyssolveCSS3
			{
				animation-name: flyssolve3;
			}
			.flyssolveCSS4
			{
				animation-name: flyssolve4;
			}
			.flyssolveCSS5
			{
				animation-name: flyssolve5;
			}
			.flyssolveCSS6
			{
				animation-name: flyssolve6;
			}
			.flyssolveCSS7
			{
				animation-name: flyssolve7;
			}
			.flyssolveCSS8
			{
				animation-name: flyssolve8;
			}
			.flyssolveCSS9
			{
				animation-name: flyssolve9;
			}
			.flyssolveCSS10
			{
				animation-name: flyssolve10;
			}
			.flyssolveCSS11
			{
				animation-name: flyssolve11;
			}
			.flyssolveCSS12
			{
				animation-name: flyssolve12;
			}
			.aiCSS
			{
				position: absolute;
				width: 200px;
				height: 200px;
			}
			.aiImgCSS
			{
				/*But now this absolute positioning will be positioning with the AI Span*/
				position: absolute;
				width: 100px;
				height: 100px;
				top: 0%;
				left: 0%;
			}
			.aiImgCSSRight
			{
				position: absolute;
				width: 100px;
				height: 100px;
				top: 0%;
				right: 0%;
			}
			.aiCardImgCSS
			{
				position: absolute;
				width: 50px;
				height: 60px;
				top: 20%;
				left: 50%;
				padding-left: 4px;
			}
			.aiCardImgCSSRight
			{
				position: absolute;
				width: 50px;
				height: 60px;
				top: 20%;
				left: 20%;
			}
			.tempCardCountCSS, .tempCardCountCSSRight
			{
				position: absolute;
				font: bolder 16pt comic sans ms;
			}
			.tempCardCountCSS
			{
				top: 27%;
				left: 57%;
			}
			.tempCardCountCSSRight
			{
				top: 26%;
				left: 25%;
			}
			#centerDeckHTML
			{
				position:absolute;
				top: 45vh;
				left: 48%;
				transform: rotateX(60deg);
			}
			#currentNumHTML
			{
				position: absolute;
				top: 47vh;
				left: 55%;
				font: 14pt trebuchet ms;
				color: gold;
			}
		</style>
		<script src="classes.js"></script>
		<script>
			function initialize() {
				gameLog = document.getElementById("gameLogHTML");
				gameLogLog = document.getElementById("gameLogLogHTML");
				gameLog.style.visibility = "hidden";
				playerStache = document.getElementById("playerStacheHTML"); //Will only contain cards
				currentNum = document.getElementById("currentNumHTML");

				//Game Variables
				playBtnState = false;
				configPlayButton();

				//Creates the basic players and the card deck
				playerCount = parseInt(localStorage.playerNum);
				deck = new Deck();
				deck.generateDeck();
				deck.shuffleDeck();

				//The game log is stored in an array
				gameLogEvents = [];

				//Stuff inside the center pile
				centerPile = [];
				lastPlayedCards = [];

				//The rank/card value that the game is at
				currentValue = 1;

				//The order of the player that is going to play the card next
				currentPlayer = 0;

				//Here we use an array to loop through AI functions with respect to their turn order. 
				bluffActions = [];

				//Store all the AI inside an array for easy access. The player is stored first
				playerArray = [];

				//Gets the game ready
				createPlayerCount();

				//Displays the AIs on the frontend
				displayPlayers();
			}
			function nextTurn() //Updates the information needed for the next turn
			{
				currentValue++;
				if (currentValue == 14) //If needed, reset current value back to 1
				{
					currentValue = 1;
				}

				currentNum.innerHTML = `Current Card: <br />${valueLoop[currentValue]}`;

				//Determines the next player, and calls on the player to play a card
				currentPlayer++;
				if (currentPlayer > playerCount) //If the player number is > playerCount, we should reset the current player to 0 and call the user to play
				{
					for (var g = 0; g < playerStache.children.length; g++)
					{
						playerStache.children[g].style.pointerEvents = "auto"; //Stop player from interacting with keyboard
					}

					currentPlayer = 0;
					configPlayButton();
				}
				else //If not, call for the AI to make a move
				{
					aiPlay(playerArray[currentPlayer]);
				}
			}
			function createPlayerCount() 
			{
				for (var i=0; i<=playerCount; i++)
				{
					playerArray.push(new Player);
				}

				//Makes sure the first player is not AI
				playerArray[0].isAi = false; //Might remove for a better for loop

				distributeCard();
			}
			function distributeCard() //Hands out the cards
			{
				let number = 0;

				//While there are still cards in the deck, distribute them to the players
				while (deck.deck.length != 0)
				{
					//Remove the last card in the deck, and add the card to the player's hand.
					let removedCard = deck.deck.pop();
					playerArray[number].addCard(removedCard);

					//If the next player does not exist, go back to the first player and distribute the cards for them
					//If the next player does exist, distribute the cards to them
					if (playerArray[number + 1] == null)
					{
						number = 0;
					}
					else
					{
						number++;
					}
				}

				//Displays the player's hand in the frontend
				playerArray[0].updateHand(playerStache);
			}
			function activateMouseShortcut(e) //Different keys will prompt different commands to run based on mouse shortcuts
			{
				if (e.which == 101) //If the key pressed is E, open the log
				{
					if (gameLog.style.visibility == "hidden")
					{
						gameLog.style.visibility = "visible";

						gameLog.classList.add("appear");

						try
						{
							gameLog.classList.remove("disappear");
						}
						catch
						{
							console.log("First time initating log");
						}
					}
				}
				if (e.which == 102) //If the key pressed is F, close the log by making it invisible
				{
					if (gameLog.style.visibility == "visible")
					{
						gameLog.classList.add("disappear");

						window.setTimeout(function() {
							gameLog.style.visibility = "hidden";
							gameLog.classList.remove("appear");
						}, 1000);
					}
				}
			}
			function logPlay(text) //Logs a move in front of everything
			{
				let tempLi = document.createElement("li");
				tempLi.innerHTML = text;
				tempLi.style.color = "lightblue";

				gameLogLog.insertBefore(tempLi, gameLogLog.children[0]);
			}
			function logWipe() //Turns everything not in the last four turns white
			{
				for (var i=0; i<gameLogLog.children.length; i++)
				{
					gameLogLog.children[i].style.color = "white";
				}
			}
			function displayPlayers()
			{
				//Creates Divs and Spans for the AI players
				for (var i=1; i<playerArray.length; i++)
				{
					let tempSpan = document.createElement("span");
					tempSpan.className = "aiCSS";

					playerArray[i].bind(tempSpan);

					let tempImg = document.createElement("img");
					tempImg.src = `Images/player${i}.jpg`;
					tempImg.className = "aiImgCSS";
					tempSpan.appendChild(tempImg);

					let tempCardImg = document.createElement("img");
					tempCardImg.src = "Images/back-red-75-1.png";
					tempCardImg.className = "aiCardImgCSS";
					tempSpan.appendChild(tempCardImg);

					document.body.appendChild(tempSpan);
				}

				/*Since there are alot of different player numbers, we need to decide where the players go on the game screen 
				after each customizable player count. The code here uses the object we binded to the backend AI player class object
				to adjust the absolute positioning*/

				let setAIPosition = function(number, animationClassName, top, leftOrRight, isRight) {
					playerArray[number].animationClassName = animationClassName;

					let currentObject = playerArray[number].aiDisplay;
					currentObject.style.top = top;

					//Get the card number display right on top of the cards
					//Creates the card display so we can later get it right on top of the cards
					let tempCardCount = document.createElement("span");
					tempCardCount.innerHTML = playerArray[number].hand.length;

					//Allows us to be lazy and put no value for isRight
					if (isRight == undefined) 
					{
						currentObject.style.left = leftOrRight;
						tempCardCount.className = "tempCardCountCSS";
					}
					else if (isRight) //If the card is on the right, reverse the CSS frontend positioning template
					//First child of the span is image, second child of span is card image
					{
						currentObject.style.right = leftOrRight;
						currentObject.children[0].className = "aiImgCSSRight";
						currentObject.children[1].className = "aiCardImgCSSRight";
						tempCardCount.className = "tempCardCountCSSRight";
					}

					currentObject.appendChild(tempCardCount);
				}

				switch (playerCount)
				{
					case 3:
						setAIPosition(1, "flyssolveCSS4", "30vh", "2%");
						setAIPosition(2, "flyssolveCSS6", "1vh", "40%");
						setAIPosition(3, "flyssolveCSS5", "30vh", "2%", true);
					break;

					case 4:
						setAIPosition(1, "flyssolveCSS4", "30vh", "2%");
						setAIPosition(2, "flyssolveCSS11", "1vh", "20%");
						setAIPosition(3, "flyssolveCSS12", "1vh", "20%", true);
						setAIPosition(4, "flyssolveCSS5", "30vh", "2%", true);
					break;

					case 5:
						setAIPosition(1, "flyssolveCSS8", "40vh", "2%");
						setAIPosition(2, "flyssolveCSS7", "15vh", "2%");
						setAIPosition(3, "flyssolveCSS6", "1vh", "40%");
						setAIPosition(4, "flyssolveCSS9", "15vh", "2%", true);
						setAIPosition(5, "flyssolveCSS10", "40vh", "2%", true);
					break;
				}
			}
			//AI Turn
			function aiPlay(player)
			{
				//Play the card, record it, and setTimeout for next turn
				let numPlayedCards = player.playCard();
				logPlay(`Player ${currentPlayer} has played ${numPlayedCards} cards`);

				//Takes the display that shows the number of cards
				player.aiDisplay.children[2].innerHTML = `${player.hand.length}`;

				for (var i=0; i<numPlayedCards; i++)
				{
					let tempNewCard = new Card("back-red-75", "1").createCard(document.body);
					tempNewCard.style.position = "absolute";
					tempNewCard.style.top = "120vh";
					tempNewCard.style.left = "45%";
								
					tempNewCard.classList.add(player.animationClassName);

					tempNewCard.style.animationDelay = `${(0.5*i)}s`
					window.setTimeout(function() {
						tempNewCard.remove();
					}, (2000+(500*i)));
				}

				//We can clear this timer later for the bullshit animations
				turnTimer = window.setTimeout(nextTurn, 5000);
			}

			//Player Turn
			function configPlayButton() //Configures the card play button depending on if it is the player's turn or if they can play the card
			{
				if (document.body.querySelector('#playBtnHTML') != null)
				{
					tempPlayBtn.remove();
				}
				else if (document.body.querySelector('#bullshitBtnHTML') != null)
				{
					tempBullshitBtn.remove();
				}

				playBtnState = !playBtnState; //Changes the play button state

				if (playBtnState)
				{
					//Displays the card playing interface
					logWipe();

					tempPlayBtn = document.createElement("span");
					tempPlayBtn.id = "playBtnHTML";
					tempPlayBtn.innerHTML = "<br />Play<br />Card";

					tempPlayBtn.addEventListener("click", function() {
						let numSelected = playerArray[0].checkNumSelected();

						if (numSelected > 4) //If the number of card selected is too much, the game refuses to play the cards
						{
							let tempItem = document.createElement("div");
							tempItem.className = "warningDivCSS";
							tempItem.innerHTML = "You can't play more than 4 cards";

							document.body.appendChild(tempItem);

							//Disable all pointer events on the button for the time being
							tempPlayBtn.style.pointerEvents = "none";

							window.setTimeout(function() {
								tempPlayBtn.style.cursor = "pointer";
								tempPlayBtn.style.pointerEvents = "auto";
								tempItem.remove();
							}, 3000);

							return;
						}
						else if (numSelected == 0) //If nothing is selected, don't play
						{
							let tempItem = document.createElement("div");
							tempItem.className = "warningDivCSS";
							tempItem.innerHTML = "You need to select a card";

							document.body.appendChild(tempItem);

							tempPlayBtn.style.pointerEvents = "none";

							window.setTimeout(function() {
								tempPlayBtn.style.cursor = "pointer";
								tempPlayBtn.style.pointerEvents = "auto";
								tempItem.remove();
							}, 3000);
						}
						else //If it's all fine, play it
						{
							//Yeet all the cards that are up in accordance with the returned array 

							let childrenIndexes = playerArray[0].selectionArray();

							tempNewCardArray = [];

							for (var i=(childrenIndexes.length-1); i>=0; i--) //Loops through all the children, and remove them when their animation gets faded
							{
								//Creates a new temporary card that has document.body as its parent, so absolute positioning
								//will work on the body instead of the card stache div
								let indexNum = childrenIndexes[i];

								playerStache.children[indexNum].remove();

								logPlay(`You played ${cardsValues[playerArray[0].hand[childrenIndexes[i]].value]}!`);

								let tempNewCard = new Card("back-red-75", "1").createCard(document.body);
								tempNewCard.style.position = "absolute";
								tempNewCard.style.top = "80vh";
								tempNewCard.style.left = "45%";
								
								tempNewCard.classList.add(`flyssolveCSS${i}`);
								tempNewCardArray.push(tempNewCard);
							}

							//Removes all the cards visible, and creates new ones. 
							//Creates a promise to have the rest of the code executed after the setTimeout

							let calcAftermath = async function() {
								playerArray[0].playCard();
								let updateFrontend = new Promise( function(resolve, reject)
								{
									window.setTimeout(function(){
										for (var c=(playerStache.children.length-1); c>=0; c--)
										{
											playerStache.children[c].remove();
										}

										resolve();
									}, 2000)
								});

								await updateFrontend;

								for (var f in tempNewCardArray) //Removes the back card covers
								{
									tempNewCardArray[f].remove();
								}

								playerArray[0].updateHand(playerStache);

								for (var g = 0; g < playerStache.children.length; g++)
								{
									playerStache.children[g].style.pointerEvents = "none"; //Stop player from interacting with keyboard
								}

								window.setTimeout(function(){
									nextTurn();
									configPlayButton();
								}, 3000);
							}

							calcAftermath();
						}
					})
					document.body.appendChild(tempPlayBtn);
				}
				else
				{
					tempBullshitBtn = document.createElement("span");
					tempBullshitBtn.id = "bullshitBtnHTML";
					tempBullshitBtn.innerHTML = "<br />Call<br />BS";

					tempBullshitBtn.addEventListener("click", function() {

						//Stops the timer for now
						window.clearTimeout(turnTimer);

						tempBullshitBtn.style.pointerEvents = "none"; //Stops the player from calling bs infinite times

						let areCardsValid = true;
					
						//Loops through the last played cards to see if the cards are valid
						for (var i in lastPlayedCards)
						{
							if (lastPlayedCards[i].value != currentValue)
							{
								areCardsValid = false;
								break; //No need to continue the loop, just skip it if card is trash
							}
						}

						if (areCardsValid)
						{
							//If cards are valid, the player pick up the whole deck
							for (var i in centerPile)
							{
								playerArray[0].addCard(centerPile[i]);
							}

							//Sends the tempCard in the player's hand, then animates it
							let tempNewCard = new Card("back-red-75", "1").createCard(document.body);
							tempNewCard.style.position = "absolute";
							tempNewCard.classList.add(`flyssolveCSS1`);
							tempNewCard.style.animationDuration = "3s";
							tempNewCard.style.animationDirection = "reverse";

							//Updates the cards in the player's hand on the frontend
							//Does this with a delay in order to give the player the feeling of stuff being updated
							window.setTimeout(function() {
								tempNewCard.remove();

								for (var c=(playerStache.children.length-1); c>=0; c--)
								{
									playerStache.children[c].remove();
								}

								playerArray[0].updateHand(playerStache);
							}, 3000);
							centerPile = [];
						}
						else
						{
							//If cards are not valid, add all the cards last played into the player's hand
							for (var i in centerPile)
							{
								//Current player did not update yet because we didn't clear time out
								//Do not update display because the AI does not have a visual display
								playerArray[currentPlayer].addCard(centerPile[i]);
							}

							//Creates a new card and animates the player picking up the entire deck
							let tempNewCard = new Card("back-red-75", "1").createCard(document.body);
							tempNewCard.style.position = "absolute";	
							tempNewCard.classList.add(playerArray[currentPlayer].animationClassName);
							tempNewCard.style.animationDirection = "reverse";

							//Removes the animated card
							window.setTimeout(function() {
								tempNewCard.remove();
							}, 2000);

							//Resets the center pile
							centerPile = [];

							//Updates AI card display of how much cards the AI has
							playerArray[currentPlayer].aiDisplay.children[2].innerHTML = `${playerArray[currentPlayer].hand.length}`;
						}

						//Continue the game and resets bs button
						turnTimer = window.setTimeout(function() {
							nextTurn();
							tempBullshitBtn.style.pointerEvents = "auto";
						}, 5000);
					});

					document.body.appendChild(tempBullshitBtn);
				}				
			}
		</script>
	</head>
	<body onload="initialize();">
		<div id="gameLogHTML">
			<div id="gameLogTitleHTML">Game Log <br /></div>
			<ul id="gameLogLogHTML">
				<li>Player first accessed the game logs. Events in the last four turns are in blue</li>
			</ul>
		</div>

		<div id="playerStacheHTML">
		</div>

		<img src="Images/back-red-75-1.png" id="centerDeckHTML"/>
		<span id="currentNumHTML">Current Card: <br /></span>
	</body>
</html>