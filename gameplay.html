<!DOCTYPE HTML>
<html onkeypress="activateMouseShortcut(event);">
	<head>
		<title></title>
		<link href="animations.css" rel="stylesheet" />
		<style>
			html
			{
				background-image: url("Images/pokerTable.jpg");
				background-size: cover;
				background-repeat: no-repeat;
				overflow-y: hidden;
			}
			#gameLogHTML
			{
				position: absolute;
				top: 20vh;
				left: 30%;
				background-color: rgba(15, 15, 15, 0.7);
				color: white;
				overflow: auto;
				font: 18pt trebuchet ms;
				padding: 8px;
			}
			#gameLogTitleHTML
			{
				background-color: #2093e6;
				font: 32pt trebuchet ms;
				padding: 8px;
			}
			.appear
			{
				visibility: visible;
				animation-name: appear;
				animation-fill-mode: forwards;
				animation-duration: 1s;
			}
			.disappear
			{
				/*JS will asynchronously hide this*/
				animation-name: disappear;
				animation-fill-mode: forwards;
				animation-duration: 1s;
			}
			#playerStacheHTML
			{
				border-bottom: 5px solid black;
				position: absolute;
				left: 20%;
				width: 60%;
				top: 80vh;
				height: 16vh;
				overflow-x: scroll;
				overflow-y: hidden;
				white-space: nowrap;
			}
			#tempPlayBtnHTML, #tempBullshitBtnHTML
			{
				position: absolute;
				right: 5%;
				bottom: 5vh;
				text-align: center;
				border-radius: 50%;
				width: 150px;
				height: 150px;
				font: 28pt trebuchet ms;
				color: white;
				border: 8px outset black;
				box-shadow: 2px 2px 6px 5px black;
				cursor: pointer;
				animation-duration: 10s;
				animation-iteration-count: infinite;
				animation-direction: alternate;
			}
			#tempPlayBtnHTML
			{
				background-color: #4ac3f7;;
				animation-name: blueFlash;
			}
			#tempBullshitBtnHTML
			{
				background-color: #ffc936;
				animation-name: goldFlash;
			}
			.warningDivCSS
			{
				position: absolute;
				top: 70vh;
				left: 0%;
				color: #f55733;
				width: 99%;
				font: 24pt comic sans ms;
				text-align: center;
			}
			.flyssolveCSS0, .flyssolveCSS1, .flyssolveCSS2, .flyssolveCSS3
			{
				position: absolute;
				animation-duration: 3s;
				animation-fill-mode: forwards;
				transform: rotateX(80deg);
			}
			.flyssolveCSS0
			{
				animation-name: flyssolve0;
			}
			.flyssolveCSS1
			{
				animation-name: flyssolve1;
			}
			.flyssolveCSS2
			{
				animation-name: flyssolve2;
			}
			.flyssolveCSS3
			{
				animation-name: flyssolve3;
			}
		</style>
		<script src="classes.js"></script>
		<script>
			function initialize() {
				gameLog = document.getElementById("gameLogHTML");
				gameLogLog = document.getElementById("gameLogLogHTML");
				gameLog.style.visibility = "hidden";
				playerStache = document.getElementById("playerStacheHTML"); //Will only contain cards

				//Game Variables
				playBtnState = false;
				configPlayButton();

				//Creates the basic players and the card deck
				playerCount = 5;
				deck = new Deck();
				deck.generateDeck();
				deck.shuffleDeck();

				//The game log is stored in an array
				gameLogEvents = [];

				//Here we use an array to loop through AI functions with respect to their turn order. 
				playActions = [];
				bluffActions = [];

				//Store all the AI inside an array for easy access. The player is stored first
				playerArray = [];

				//Gets the game ready
				createPlayerCount();
			}
			function createPlayerCount() 
			{
				for (var i=0; i<playerCount; i++)
				{
					playerArray.push(new Player);
				}

				//Makes sure the first player is not AI
				playerArray[0].isAi = false; //Might remove for a better for loop

				distributeCard();
			}
			function distributeCard() //Hands out the cards
			{
				let number = 0;

				//While there are still cards in the deck, distribute them to the players
				while (deck.deck.length != 0)
				{
					//Remove the last card in the deck, and add the card to the player's hand.
					let removedCard = deck.deck.pop();
					playerArray[number].addCard(removedCard);

					//If the next player does not exist, go back to the first player and distribute the cards for them
					//If the next player does exist, distribute the cards to them
					if (playerArray[number + 1] == null)
					{
						number = 0;
					}
					else
					{
						number++;
					}
				}

				//Displays the player's hand in the frontend
				playerArray[0].updateHand(playerStache);
			}
			function activateMouseShortcut(e) //Different keys will prompt different commands to run based on mouse shortcuts
			{
				if (e.which == 101) //If the key pressed is E, open the log
				{
					if (gameLog.style.visibility == "hidden")
					{
						gameLog.style.visibility = "visible";

						gameLog.classList.add("appear");

						try
						{
							gameLog.classList.remove("disappear");
						}
						catch
						{
							console.log("First time initating log");
						}
					}
				}
				if (e.which == 102) //If the key pressed is F, close the log by making it invisible
				{
					if (gameLog.style.visibility == "visible")
					{
						gameLog.classList.add("disappear");

						window.setTimeout(function() {
							gameLog.style.visibility = "hidden";
							gameLog.classList.remove("appear");
						}, 1000);
					}
				}
			}
			function logPlay(text) //Logs a move in front of everything
			{
				let tempLi = document.createElement("li");
				tempLi.innerHTML = text;
				tempLi.style.color = "lightblue";

				gameLogLog.insertBefore(tempLi, gameLogLog.children[0]);
			}
			function logWipe() //Turns everything not in the last four turns white
			{
				for (var i=0; i<gameLogLog.children.length; i++)
				{
					gameLogLog.children[i].style.color = "white";
				}
			}

			//Player Turn
			function configPlayButton() //Configures the card play button depending on if it is the player's turn or if they can play the card
			{
				if (document.body.querySelector('tempPlayBtnHTML') != null)
				{
					tempPlayBtn.remove();
				}
				else if (document.body.querySelector('tempBullshitBtnHTML') != null)
				{
					tempBullshitBtn.remove();
				}

				playBtnState = !playBtnState; //Changes the play button state

				if (playBtnState)
				{
					//Displays the card playing interface

					tempPlayBtn = document.createElement("span");
					tempPlayBtn.id = "tempPlayBtnHTML";
					tempPlayBtn.innerHTML = "<br />Play<br />Card";

					tempPlayBtn.addEventListener("click", function() {
						let numSelected = playerArray[0].checkNumSelected();

						if (numSelected > 4) //If the number of card selected is too much, the game refuses to play the cards
						{
							let tempItem = document.createElement("div");
							tempItem.className = "warningDivCSS";
							tempItem.innerHTML = "You can't have more than 4 cards";

							document.body.appendChild(tempItem);

							//Disable all pointer events on the button for the time being
							tempPlayBtn.style.pointerEvents = "none";

							window.setTimeout(function() {
								tempPlayBtn.style.cursor = "pointer";
								tempPlayBtn.style.pointerEvents = "auto";
								tempItem.remove();
							}, 3000);

							return;
						}
						else if (numSelected == 0) //If nothing is selected, don't play
						{
							let tempItem = document.createElement("div");
							tempItem.className = "warningDivCSS";
							tempItem.innerHTML = "You need to select a card";

							document.body.appendChild(tempItem);

							tempPlayBtn.style.pointerEvents = "none";

							window.setTimeout(function() {
								tempPlayBtn.style.cursor = "pointer";
								tempPlayBtn.style.pointerEvents = "auto";
								tempItem.remove();
							}, 3000);
						}
						else //If it's all fine, play it
						{
							//Yeet all the cards that are up in accordance with the returned array 

							let childrenIndexes = playerArray[0].selectionArray();

							tempNewCardArray = [];

							for (var i=(childrenIndexes.length-1); i>=0; i--) //Loops through all the children, and remove them when their animation gets faded
							{
								//Creates a new temporary card that has document.body as its parent, so absolute positioning
								//will work on the body instead of the card stache div
								let indexNum = childrenIndexes[i];

								playerStache.children[indexNum].remove();

								logPlay(`You played ${cardsValues[playerArray[0].hand[childrenIndexes[i]].value]}!`);

								let tempNewCard = new Card("back-red-75", "1").createCard(document.body);
								tempNewCard.style.position = "absolute";
								tempNewCard.style.top = "80vh";
								tempNewCard.style.left = "45%";
								
								tempNewCard.classList.add(`flyssolveCSS${i}`);
								tempNewCardArray.push(tempNewCard);
							}

							//Removes all the cards visible, and creates new ones. 
							//Creates a promise to have the rest of the code executed after the setTimeout

							let calcAftermath = async function() {
								playerArray[0].playCard();
								let updateFrontend = new Promise( function(resolve, reject)
								{
									window.setTimeout(function(){
										for (var c=(playerStache.children.length-1); c>=0; c--)
										{
											playerStache.children[c].remove();
										}

										resolve();
									}, 3000)
								});

								await updateFrontend;

								for (var f in tempNewCardArray) //Removes the back card covers
								{
									tempNewCardArray[f].remove();
								}

								playerArray[0].updateHand(playerStache);

								window.setTimeout(function(){
									alert("yoy");
									configPlayButton();
								}, 3000);
							}

							calcAftermath();
						}
					})
					document.body.appendChild(tempPlayBtn);
				}
				else
				{
					tempBullshitBtn = document.createElement("span");
					tempBullshitBtn.id = "tempBullshitBtnHTML";
					tempBullshitBtn.innerHTML = "<br />Call<br />BS";

					tempBullshitBtn.addEventListener("click", function() {
						alert("Call Bluff");
					});

					document.body.appendChild(tempBullshitBtn);
				}
			}
		</script>
	</head>
	<body onload="initialize();">
		<div id="gameLogHTML">
			<div id="gameLogTitleHTML">Game Log <br /></div>
			<ul id="gameLogLogHTML">
				<li>Player first accessed the game logs. Events in the last four turns are in blue</li>
			</ul>
		</div>

		<div id="playerStacheHTML">
		</div>
	</body>
</html>